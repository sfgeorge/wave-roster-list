<?xml version="1.0" encoding="UTF-8"?>
<Module>
	<ModulePrefs title="Hello Wave">
		<Require feature="wave" />
		<Require feature="dynamic-height" /> 
		<Require feature="locked-domain" />  
	</ModulePrefs>
	<Content type="html"><![CDATA[


		<style type="text/css">
			* { margin: 0; padding: 0; }
			ul, ol
			{
				list-style-image: none;
				list-style-position: outside;
				list-style-type: none;
			}
			.hidden { display: none; }

			ul.participants li { padding-bottom: 1px; }
			.profileimg { padding-right: 5px; vertical-align: middle; }
			.glite { background-color: #eeeeee; }
			.showall { padding-left: 10px; font-size: smaller; }
		</style>

		<div id="content_div">
			<form name="searchform" method="get" onsubmit="javascript:return false;">
				<div>
					<input type="text" id="term" name="term" value="" onfocus="checkDefaultText( this ); return true;" onkeyup="form_change(); return true;" />
					<a href="#show-all" class="showall" onclick="javascript:refresh(); return false;">show all</a>
				</div>
				<div>
					<div><div id="participants_container"></div></div>
					<div id="options">
						<input id="show_images" name="show_images" type="checkbox" checked="checked" onchange="form_change(); return true;" />
						<label for="show_images">Show images</label>
					</div>
				</div>
			</form>
		</div>

		<script language="JavaScript" type="text/javascript">

			var MAX_SHOWN = 10;
			var initialized = false;
			var show_default_text = true;

			function renderList( searchterm )
			{
				if( ! initialized )
				{
					initialized = true;
					return;
				}

				if( show_default_text )
				{
					document.getElementById( 'term' ).value = "(Search " + wave.getParticipants().length + " participants)";
					return;
				}

				if(!wave.getState()) { return; }
				addOptions( wave.getParticipants(), searchterm );
			}

			function addOptions( participants, searchterm )
			{
				participants_container = document.getElementById( 'participants_container' );
				searchform = document.forms[ 'searchform' ];
				do_show_images = searchform.elements[ 'show_images' ].checked;
				list_html = "";
				num_participants = participants.length;
				num_matches = 0;
				highlight = true;
				for( var i = 0; i < num_participants; i++ )
				{
					highlight = ! highlight;
					label = getLabel( participants[ i ] );
					if( searchterm && searchterm != "" )
					{
						pattern = "(" + RegExp.escape( searchterm ) + ")";
						searchpattern = new RegExp( pattern, 'ig' );
						if( ! label.match( searchpattern ) )
						{
							continue;
						}
						label = label.replace( searchpattern, "<strong>$1</strong>" );
					}
					num_matches++;
					li_attr = '';
					img_html = '';
					if( do_show_images )
					{
						profile_img = participants[ i ].getThumbnailUrl();
						if( profile_img )
						{
							display_name = participants[ i ].getDisplayName();
							img_html = '<img src="' + profile_img + '" class="profileimg" width="40" height="40" title="' + display_name + '" alt="' + display_name + '" />';
						}
					}
					else if( highlight )
					{
						li_attr = ' class="glite"';
					}
					list_html += '<li' + li_attr + '>' + img_html + label + "</li>\n";

					if( num_matches == MAX_SHOWN ) { break; }
				}

				// Finally, update the list
				participants_container.innerHTML = "<div>Showing <strong>" + num_matches
					+ "</strong> of <strong>" + num_participants + "</strong></div>\n"
					+ '<ul class="participants">\n' + list_html + "</ul>\n";

				// Tells gadget to resize itself
				gadgets.window.adjustHeight();	
			}

			function getLabel( participant )
			{
				return participant.getDisplayName()
					+ " (" + participant.getId() + ")";
			}

			function checkDefaultText( term )
			{
				if( show_default_text )
				{
					term.value = '';
					show_default_text = false;
				}
			}

			function form_change()
			{
				renderList( document.getElementById( 'term' ).value );
			}

			function refresh()
			{
				document.getElementById( 'term' ).value = '';
				show_default_text = false;
				renderList();
				show_default_text = true;
				renderList();
			}

			function init()
			{
				// Thanks to http://simonwillison.net/2006/Jan/20/escape/
				RegExp.escape = function(text)
				{
					if (!arguments.callee.sRE)
					{
						var specials =
						[
							'/', '.', '*', '+', '?', '|',
							'(', ')', '[', ']', '{', '}', '\\'
						];
						arguments.callee.sRE = new RegExp( '(\\' + specials.join('|\\') + ')', 'g' );
					}
					return text.replace(arguments.callee.sRE, '\\$1');
				}

				if (wave && wave.isInWaveContainer())
				{
					wave.setStateCallback( renderList );
					wave.setParticipantCallback( renderList );
				}
			}
			gadgets.util.registerOnLoadHandler(init);
		</script>


	]]></Content>
</Module>